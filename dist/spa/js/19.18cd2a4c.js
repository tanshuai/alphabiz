(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[19],{"9c2e":function(e,t,s){"use strict";s("d9e2"),s("ddb0"),s("2b3d"),s("9861"),s("5319");var a=s("acf9"),r=s.n(a),i=s("1c37"),n=s.n(i);const o=s("3e8f"),l=s("df7c");async function c(e){console.log(e);const t=l.dirname(e),s=l.extname(e);let a=l.basename(e);if(a=a.slice(0,a.length-s.length),console.tag("Player","getSubtitleFromFilename").log({dirname:t,basename:a,ext:s}),!o.existsSync(t))throw new Error("dirname not found: "+t);const r=[d(),u()];let i=[];try{const e=o.readdirSync(t);i=await Promise.all(e.map((async e=>{if(!e.startsWith(a))return;const s=r.find((t=>e.endsWith(`.${t.ext}`)));if(!s)return;const i=l.join(t,e),n=await o.promises.readFile(i),c=s.convert(n);return console.log("sub","converted",!!c),c?{filename:i,src:URL.createObjectURL(new Blob([c])),id:e}:void 0}))).then((e=>e.filter((e=>!!e))))}catch(n){console.log(n)}return i}function u(){return{ext:"vtt",convert(e){const t=r.a.decode(e,n.a.detect(e)).replace(/^{[\\0-9A-Za-z&]*}/gm,"");return t}}}function d(){return{ext:"srt",convert(t){const s=r.a.decode(t,n.a.detect(t)).replace(/^{[\\0-9A-Za-z&]*}/gm,"");return e(s)}};function e(e){var s=e.replace(/\r+/g,"");s=s.replace(/^\s+|\s+$/g,"").replace(/\n\d+\n\d+/g,(e=>"\n"+e));var a=s.split(/\n{2,}/g),r="";if(a.length>0){r+="WEBVTT\n\n";for(var i=0;i<a.length;i+=1)r+=t(a[i])}return r}function t(e){var t="",s=e.split(/\n/);if(!s[0]||!s[1])return console.log(e),"";while(s.length>3){for(var a=3;a<s.length;a++)s[2]+="\n"+s[a];s.splice(3,s.length-3)}var r=0;if(!s[0].match(/\d+:\d+:\d+/)&&s[1].match(/\d+:\d+:\d+/)&&(t+=s[0].match(/\w+/)+"\n",r+=1),!s[r].match(/\d+:\d+:\d+/))return"";var i=s[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/);return i?(t+=i[1]+":"+i[2]+":"+i[3]+"."+i[4]+" --\x3e "+i[5]+":"+i[6]+":"+i[7]+"."+i[8]+"\n",r+=1,s[r]&&(t+=s[r]+"\n\n"),t):""}}t["a"]=c},aa3b:function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("q-page",{staticClass:"bg-black overflow-hidden",staticStyle:{height:"calc(100vh - 50px - var(--appbar-height, 0px))!important",padding:"1px"}},[s("VideoJsPlayer",{ref:"videoJsPlayer",staticClass:"full-width full-height",on:{openFile:e.addSubtitles}})],1)},r=[],i=s("aed2"),n=i["a"],o=s("2877"),l=s("9989"),c=s("eebe"),u=s.n(c),d=Object(o["a"])(n,a,r,!1,null,null,null);t["default"]=d.exports;u()(d,"components",{QPage:l["a"]})},aed2:function(e,t,s){"use strict";(function(e){s("ddb0"),s("2b3d"),s("9861"),s("5319");var a=s("77d8"),r=s("41ed"),i=s("0613"),n=s("9c2e"),o=s("849b"),l=s("f880");const c=s("ed08").isElectron();function u(){return{data(){return{player:null,sourceAbortController:null}},mounted(){this.player=this.$refs.videoJsPlayer.player},methods:{async setSource(e){if(console.log("Player","setSource",e),await this.player.promiseReady,this.sourceAbortController instanceof AbortController){const e=this.sourceAbortController.signal;e.aborted||(console.log("Abort previous signal before setting source"),this.sourceAbortController.abort())}this.sourceAbortController=new AbortController,await this.player.setSource(e,this.sourceAbortController.signal),c&&await this.addSubtitles()},play(){console.log("PLAY",this.player),this.player.play()},async stop(){var e;(this.player.states.isPiP&&this.player.setPiP(!1),this.player.states.isFullscreen&&this.player.setFullscreen(!1),this.player.instance)&&(console.log(this.player.instance,this.player.instance.reset),null===(e=this.player.instance)||void 0===e||e.reset());if("removeAllListeners"in r["ipcRenderer"])r["ipcRenderer"].removeAllListeners("stream-address");else try{r["ipcRenderer"].off&&r["ipcRenderer"].off("stream-address")}catch(t){console.warn("Failed to remove stream listeners",t)}await this.player.stop(),console.log("Dispatch remotePlay reset"),await i["a"].dispatch("resetRemotePlay")},async pause(e){e&&(this.player.states.isPiP&&this.player.setPiP(!1),this.player.states.isFullscreen&&this.player.setFullscreen(!1)),this.player.states.isPaused||await this.player.pause()},setPiP(e){this.player.setPiP(e)},seek(e){this.player.seek(e)},getCurrentSourceData(){var e,t,s,a;const r=null!==(e=null===(t=this.player)||void 0===t||null===(s=t.states.currentSources)||void 0===s||null===(a=s[0])||void 0===a?void 0:a.src)&&void 0!==e?e:null,i=e=>Array.from(new URL(e).searchParams.entries()).reduce(((e,[t,s])=>({...e,[t]:s})),{});if(!r)return null;const n=this.player.states.currentSources[0];return{url:r,params:i(r),infoHash:n.infoHash}},async addSubtitles(){const e=this.player.states.currentSources[0];let t;if(e.filename?t=e.filename:e.file&&(t=e.file.path),!t)return;const s=await Object(n["a"])(t);console.log("Player","subtitles",s),s&&s.forEach(((e,t)=>{this.player.addTrack(e),0===t&&this.player.enableTrack(e.id)}))}},activated(){const e=this.$refs.videoJsPlayer.$el.querySelector(".video-js-player>.video-js");e.focus()}}}function d(){return{mounted(){this.$watch((()=>{var e,t;if("play_source"===(null===(e=this.$route.params)||void 0===e||null===(t=e.action)||void 0===t?void 0:t.type))return this.$route.params.action.source}),(async s=>{if(!s)return console.log("no source");console.log("Player","mixinSourcePlay","src",s.src),s.filename=e(s),s.type=t(s),console.log("Player","mixinSourcePlay","filename",s.filename),console.log("Player","mixinSourcePlay","type",s.type),await this.stop(),await this.setSource(s),this.play()}),{immediate:!0})}};function e(e){let t;return t=e.src.startsWith("play://")?decodeURI(new URL(e.src).pathname).slice(3):decodeURI(e.src),t}function t(e){return"video/mp4"}}function h(){return{mounted(){this.$watch((()=>{var e,t;if("play_file"===(null===(e=this.$route.params)||void 0===e||null===(t=e.action)||void 0===t?void 0:t.type))return this.$route.params.action.file}),(async e=>{if(!e)return console.log("no file");console.log("Player","mixinFilePlay","file",e),await this.stop(),await this.setSource({src:URL.createObjectURL(e),type:e.type,file:e}),this.play()}),{immediate:!0})}}}function p(){return c||Object(a["a"])()?{mounted(){this.$watch((()=>{var e,t;if("play_remote"===(null===(e=this.$route.params)||void 0===e||null===(t=e.action)||void 0===t?void 0:t.type))return i["a"].state.video.currentVideo.remotePlay}),(async e=>{if(!e)return;console.log("remotePlay",e,i["a"].state.video.currentVideo.infoHash),await this.stop(),i["a"].state.video.currentVideo.infoHash&&this.$nextTick((()=>{console.log("Dispatch remote",i["a"].state.video.currentVideo.infoHash),i["a"].dispatch("remotePlay",i["a"].state.video.currentVideo.infoHash)})),this.player.loadingState=!0;const s=await t.call(this);s&&this.play(),this.player.loadingState=!0}),{immediate:!0})}}:{};async function t(){const t=i["a"].state.video.currentVideo.infoHash,a=this.getCurrentSourceData();if(a&&a.infoHash===t)return;await this.stop(),await this.$nextTick();const n=await c.call(this);if(!n)return;const o=u(n,{infoHash:t});console.log(o);try{return await this.setSource(o),o.src.startsWith("http://")&&await s.call(this,o),!0}catch(d){console.error("Player","error",d)}async function c(){const t=e=>new Promise((t=>setTimeout((()=>t(null)),e))),s=await Promise.race([t(1e4),new Promise((e=>{r["ipcRenderer"].once("stream-address",((t,s)=>e(s))),r["ipcRenderer"].send("get-stream-address")}))]);var a;s?(null!==(a=s.filepath)&&void 0!==a||(s.filepath="win32"===e.platform?decodeURI(s.address).replace("play:///","").replace(/\//g,"\\"):decodeURI(s.address).replace("play://","")),console.log("Player","streamAddress",s)):console.log("Player","streamAddress").tag.red("timeout");return s}function u(t,{infoHash:s}){let a=t.address,r=t.filepath;return a.startsWith("play://")&&(a+=`?infoHash=${s}`,r||(r=decodeURI(new URL(a).pathname).slice(Object(l["d"])()?3:2))),"win32"===e.platform&&(r=r.replace(/\//g,"\\")),{src:a,type:null,filename:r,infoHash:s}}}async function s(e){const{src:t}=e;if(!/wait=0$/gm.test(t))return;const s=i["a"].state.setting.videoCacheTime;if(0===s)return;const a=60*s/this.player.states.duration,r=t.replace(/wait=.*/gm,`wait=${a}`),n=this.player.states.currentTime,o=e=>this.player.setSource(e);await o(Object.assign(e,{src:r})),this.seek(n)}}function y(){return{beforeRouteLeave(t,s,a){var r;if("signedIn"!==(null===(r=this.$store.state.account)||void 0===r?void 0:r.authState))return this.pause(),a();e.call(this),a()},beforeRouteEnter(e,s,a){a((e=>t.call(e)))},mounted(){const e=()=>"Player"===this.$route.name;this.$watch((()=>{var e;return null===(e=this.player)||void 0===e?void 0:e.states.isPiP}),(t=>{t||this.player.states.isPaused||e()||this.$router.push({name:"Player"})}))}};function e(){var e,t;this.player&&0!==(null!==(e=null===(t=this.player.states.currentSources)||void 0===t?void 0:t.length)&&void 0!==e?e:0)&&(this.player.states.isPaused||this.player.states.isPiP||"object"!==typeof this.player.states.loadingState&&c&&this.setPiP(!0))}function t(){this.player&&this.player.states.isPiP&&this.setPiP(!1)}}function f(){return{inject:["io"],mounted(){this.$amplify.addOnAuthStateChangedListener((async e=>{console.log("Player","PiP","signedOut",{authState:e}),"signedOut"===e&&await this.pause(!0)})),(c||Object(a["a"])())&&r["ipcRenderer"].on("pause-player",(()=>this.pause(!0))),this.io.on("server_progress",e.bind(this)),this.io.on("update_subtitleList",t.bind(this)),this.io.on("clear_player",s.bind(this))}};function e(e){var t,s,a,r,i,n;const o=()=>"Player"===this.$route.name;if(!o())return;const l=null!==(t=null===(s=this.player)||void 0===s||null===(a=s.states.currentSources)||void 0===a||null===(r=a[0])||void 0===r?void 0:r.src)&&void 0!==t?t:null;if(!l)return;const c=null!==(i=null===(n=e.find((e=>l.includes(e.name))))||void 0===n?void 0:n.progress)&&void 0!==i?i:null;function u(e){const t=[],s=e.length;let a=e[0],r=1;for(let i=1;i<s;i++)if(e[i]===a&&i<s-1)r+=1;else{if(e[i+1]===a){r+=1;continue}i===s-1&&(r+=1),r&&t.push({color:1===a?"gold":"transparent",length:r/s*100}),a=e[i],r=1}}c&&u(c)}function t(e,t){console.log("Player","io$update_subtitleList",{infoHash:e,subtitleList:t})}async function s({status:e,infoHash:t}){var s,a,r,i;const n=null!==(s=null===(a=this.player)||void 0===a||null===(r=a.states.currentSources)||void 0===r||null===(i=r[0])||void 0===i?void 0:i.src)&&void 0!==s?s:null,o=e=>Array.from(new URL(e).searchParams.entries()).reduce(((e,[t,s])=>({...e,[t]:s})),{});if(!n)return;const{infoHash:l}=o(n);async function c(){await this.stop()}l===t&&(/^play:\/\//gm.test(n)&&"paused"===e||(await c.call(this),await new Promise((e=>setTimeout(e,500))),/^http/gm.test(n)&&this.$q.notify(this.$t("stop_stream_player")),/^play:\/\//gm.test(n)&&this.$q.notify(this.$t("stop_player"))))}}t["a"]={name:"Player",mixins:[u(),d(),h(),p(),y(),f()],created(){o["a"].on("clear_player",(e=>{console.log("IO: Clear Player",e),this.stop()}))},activated(){console.log("Player","$route.params",this.$route.params)}}}).call(this,s("4362"))}}]);